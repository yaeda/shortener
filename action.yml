name: shortener
description: A URL Shortener
branding:
  icon: link
  color: red
inputs:
  json-database-path:
    description: path to the json database file
    required: false
    default: ./url.json
  not-found-file-path:
    description: path to the 404.html file
    required: false
    default: ./404.html
runs:
  using: composite
  steps:
    - name: Checkout
      uses: actions/checkout@v3
    - name: Build
      uses: actions/github-script@v6
      with:
        script: |
          const { JSON_DATABASE_PATH, NOT_FOUND_FILE_PATH } = process.env;
          const fs = require('fs').promises;
          const urls = require(JSON_DATABASE_PATH);
          await io.mkdirP('./_site/');
          // .nojekyll
          await exec.exec('touch ./_site/.nojekyll');
          // 404.html
          try {
            await io.cp(NOT_FOUND_FILE_PATH, './_site/404.html');
          } catch(error) {
            core.info(error.message);
            core.info('skip placement of 404.html');
          }
          // alias.html
          for (var i = 0; i < urls.length; i++) {
            const {url, alias} = urls[i];
            await fs.writeFile(`./_site/${alias}.html`, `<!DOCTYPE html><meta http-equiv="refresh" content="0;url=${url}">`)
          }
      env:
        JSON_DATABASE_PATH: ${{ inputs.json-database-path }}
        NOT_FOUND_FILE_PATH: ${{ inputs.not-found-file-path }}
    - name: Upload Artifact
      uses: actions/upload-pages-artifact@v1
      with:
        path: ./_site/
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v1
